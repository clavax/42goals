<script type="text/javascript">
Data = {};
Data.users = {$users|json::encode_array};
</script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
  function initialize() {
    var latlng = new google.maps.LatLng(0, 0);
    var myOptions = {
      zoom: 2,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    var content = DOM.element('content', {
        id: 'info-window-content'
    });
    var image = DOM.element('img', {
        appendTo: content,
        src: URL.img + 'site/no-thumbnail.png'
    });
    var header = DOM.element('h2', {
        appendTo: content,
        html: ''
    });
    var infowindow = new google.maps.InfoWindow({
        content: content
    });

    foreach (Data.users, function (i, user) {
        if (user.geo.indexOf(':') < 0) {
            return;
        }
        var coord = user.geo.split(':');
        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(coord[0], coord[1]),
            map: map,
            title: user.name
            //animation: google.maps.Animation.DROP
        });
        marker.data = user;
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
            header.setHTML(marker.data.name);
            image.src = user.thumbnail ? URL.userpics + user.thumbnail : URL.img + 'site/no-thumbnail.png';
        });
    });
  }
  document.addLoader(initialize);
</script>
{block type="ground" loose="yes"}
<div id="users-search">
    <div class="wrap">
        <ul id="me-menu">
            <li><a href="{@this}">All users</a></li>
            <li class="current">
                <img src="{@img}site/globe.png" />
                <b>By location</b>
            </li>
        </ul>
        <div id="map_canvas" style="width: 100%; height: 600px"></div>
    </div>
</div>
{/block}