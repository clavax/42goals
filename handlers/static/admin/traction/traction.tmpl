{block type="chartlib" /}
<script type="text/javascript">
window.Data = {};
Data.by_date = {$data_by_date|json::encode_array};
Data.by_count = {$data_by_count|json::encode};
Data.users = {$users_by_date|json::encode_array};

include('chart.ChartFactory');
window.Chart = ChartFactory.factory(ENV.chart_type);

document.addLoader(function () {
    // data
    var chart_data = [];
    foreach(Data.by_date, function (i, data) {
        var date = Date.fromString(data.created);
        chart_data.push({
            value: data.count,
            title: Format.date(date, 'n/j'),
            extended: Format.date(date, 'l, F j')
        });
    });

    Chart.set({
        canvas: 'data-by-date',
        width: 900,
        height: 400,
        type: 'area',
        interpolate: false,
        data: chart_data
    });
    Chart.draw();

    // users
    var chart_data = [];
    foreach(Data.users, function (i, data) {
        var date = Date.fromString(data.registered);
        chart_data.push({
            value: data.count,
            title: Format.date(date, 'n/j'),
            extended: Format.date(date, 'l, F j')
        });
    });

    Chart.set({
        canvas: 'users-by-date',
        width: 900,
        height: 400,
        type: 'area',
        interpolate: false,
        data: chart_data
    });
    Chart.draw();

    // count

    var milestones = [
        [1, '1 day'],
        [2, '2 days'],
        [3, '3 days'],
        [4, '4 days'],
        [5, '5 days'],
        [6, '6 days'],
        [7, '1 week'],
        [14, '2 weeks'],
        [21, '3 weeks'],
        [28, '1 month'],
        [59, '2 months'],
        [89, '3 months'],
        [1e5, 'forever'],
    ];
    
    var chart_data = [];
    var current = 0;
    var sum = 0;
    foreach(Data.by_count, function (i, data) {
        data *= 1;
        if (milestones[current][0] < i && current < milestones.length) {
            chart_data.push({
                value: sum,
                title: milestones[current][1],
                extended: milestones[current][1]
            });
            sum = 0;
            for (; current < milestones.length; current ++) {
                if (milestones[current][0] >= i) {
                    break;
                }
            }
        }
        sum += data;
    });
    chart_data.push({
        value: sum,
        title: milestones[current][1],
        extended: milestones[current][1]
    });

    Chart.set({
        canvas: 'data-by-count',
        width: 900,
        height: 400,
        type: 'bar',
        interpolate: false,
        data: chart_data
    });
    Chart.draw();
});
</script>
{block type="ground" loose="yes"}
<div id="communities-page-wrap">
    <div class="wrap">
        <h1>Traction</h1>
        <h2>Data by date</h2>
        <div id="data-by-date"></div>
        <h2>Users by date</h2>
        <div id="users-by-date"></div>
        <h2>Data by count</h2>
        <div id="data-by-count"></div>
    </div>
</div>
{/block}